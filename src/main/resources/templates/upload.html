<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>이미지 업로드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <h1 class="card-title text-center mb-4">이미지 업로드</h1>
                    <div class="mb-3">
                        <input type="file" id="fileInput" class="form-control" accept="image/*">
                    </div>
                    <div class="mb-3">
                        <input type="text" id="linkInput" class="form-control" placeholder="광고 링크 URL 입력">
                    </div>
                    <button onclick="uploadFile()" class="btn btn-primary w-100">업로드</button>
                    <div id="preview" class="mt-4 text-center"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById("fileInput");
    const linkInput = document.getElementById("linkInput");
    const preview = document.getElementById("preview");

    // 파일 선택 시 미리보기
    fileInput.addEventListener("change", function () {
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="미리보기" style="max-width:300px;">`;
            };
            reader.readAsDataURL(file);
        } else {
            preview.innerHTML = "";
        }
    });

    // 파일 업로드
    async function uploadFile() {
        const file = fileInput.files[0];
        const link = linkInput.value.trim();

        if (!file) {
            alert("파일을 선택하세요");
            return;
        }
        if (!link) {
            alert("광고 링크 URL을 입력하세요");
            return;
        }

        // FormData로 파일과 링크 전송
        const formData = new FormData();
        formData.append("file", file);
        formData.append("linkPath", link);

        // Presigned URL 요청
        const response = await fetch(`/s3/presigned-url?filename=${file.name}`, {
            method: "POST",
            body: formData
        });
        const data = await response.json();

        // S3 업로드
        const put = await fetch(data.url, {
            method: "PUT",
            headers: {"Content-Type": data.contentType},
            body: file
        });

        if (put.ok) {
            preview.innerHTML = `<div class="alert alert-success mt-3">업로드 완료되었습니다 ✅</div>`;
        } else {
            preview.innerHTML = `<div class="alert alert-danger mt-3">업로드 실패 ❌</div>`;
        }
    }
</script>
</body>
</html>